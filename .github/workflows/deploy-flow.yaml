###
# This GitHub action demonstrates how to build a simple CI/CD pipeline that will first deploy
# all of your Genesys Cloud objects to a development environment, run a set of platform test to ensure that
# the development environment flow is functioning properly and then if the tests pass deploy to a test
# environment.
#
# The three jobs contained here are:
#
#  deploy-email-flow-dev
#  execute-platform-tests
#  deploy-email-flow-test
#
#  The deploy-email-flow-dev and deploy-email-flow-test contain the same steps, but are configured with
#  OAuth Credentials and environment variables specific to each of our two Genesys Cloud environments (dev and test).
###s
name: Genesys Cloud Email Non-Prod Deploy
on:
  push:
    branches: [main]
  workflow_dispatch:
jobs:
  ###
  #  job: export-flow-from-test
  #
  #  COMMENTED OUT - Export has been completed successfully.
  #  Uncomment this job when you need to re-export flows from TEST environment.
  ###
  # export-flow-from-test:
  #   runs-on: ubuntu-latest
  #   env:
  #     FLOW_NAME: "CI_CD_Test_Flow"
  #     GENESYSCLOUD_OAUTHCLIENT_ID: ${{ secrets.GENESYSCLOUD_OAUTHCLIENT_ID_TEST }}
  #     GENESYSCLOUD_OAUTHCLIENT_SECRET: ${{ secrets.GENESYSCLOUD_OAUTHCLIENT_SECRET_TEST }}
  #     GENESYSCLOUD_API_REGION: "https://api.mypurecloud.com"
  #     GENESYSCLOUD_REGION: "us-east-1"
  #   steps:
  #     - uses: actions/checkout@v2
  #     - uses: ./.github/actions/genesys-cloud-dev-tools
  #     - uses: hashicorp/setup-terraform@v1
  #       with:
  #         cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
  #     - name: Verify TEST environment access
  #       run: |
  #         echo "Export job is currently disabled"
  #       shell: bash
  #     - name: Export flow from TEST environment
  #       uses: ./.github/actions/genesys-cloud-export-queues
  #     - name: Debug and verify export
  #       run: |
  #         echo "Export verification disabled"
  #       shell: bash
  #     - name: Commit exported flow and dependencies
  #       run: |
  #         echo "Commit step disabled"
  #       shell: bash

  ###
  #  job: deploy-to-dev
  #
  #  This job deploys exported resources to the DEV environment.
  #  Step 1: Deploy dependencies (queues, data actions, etc.) from genesyscloud.tf using Terraform
  #  Step 2: Publish all architect flows using Archy
  ###
  deploy-to-dev:
    runs-on: ubuntu-latest
  deploy-to-dev:
    runs-on: ubuntu-latest
    env:
      GENESYSCLOUD_OAUTHCLIENT_ID: ${{ secrets.GENESYSCLOUD_OAUTHCLIENT_ID_DEV }}
      GENESYSCLOUD_OAUTHCLIENT_SECRET: ${{ secrets.GENESYSCLOUD_OAUTHCLIENT_SECRET_DEV }}
      GENESYSCLOUD_API_REGION: "https://api.usw2.pure.cloud"
      GENESYSCLOUD_REGION: "us-west-2"
      GENESYSCLOUD_ARCHY_REGION: "usw2.pure.cloud"
      GENESYSCLOUD_EMAIL_DOMAIN: "devengagedev"
      GENESYSCLOUD_EMAIL_DOMAIN_REGION: "usw2.pure.cloud"
      TF_WORKSPACE: "2"
    steps:
      - uses: actions/checkout@v2
      
      - uses: ./.github/actions/genesys-cloud-dev-tools
      
      - uses: hashicorp/setup-terraform@v1
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
      
      - name: Verify exported resources exist
        run: |
          echo "=== Verifying Exported Resources ==="
          if [ ! -d "blueprint/genesys-cloud-cx-as-code/export/exported_resources" ]; then
            echo "✗ ERROR: No exported_resources directory found!"
            exit 1
          fi
          
          echo "✓ Exported resources found"
          echo ""
          echo "Exported Terraform resources (genesyscloud.tf):"
          ls -lh blueprint/genesys-cloud-cx-as-code/export/exported_resources/genesyscloud.tf
          echo ""
          echo "Architect Flows:"
          find blueprint/genesys-cloud-cx-as-code/export/exported_resources/architect_flows -name "*.yaml" 2>/dev/null || echo "No flows found"
        shell: bash
      
      - name: Copy exported resources to main Terraform directory
        run: |
          echo "=== Copying exported resources to remote backend directory ==="
          
          # Copy genesyscloud.tf (contains all exported resources)
          cp blueprint/genesys-cloud-cx-as-code/export/exported_resources/genesyscloud.tf \
             blueprint/genesys-cloud-cx-as-code/
          
          # Copy terraform.tfvars if exists
          if [ -f blueprint/genesys-cloud-cx-as-code/export/exported_resources/terraform.tfvars ]; then
            cp blueprint/genesys-cloud-cx-as-code/export/exported_resources/terraform.tfvars \
               blueprint/genesys-cloud-cx-as-code/
          fi
          
          # Copy scripts directory if exists
          if [ -d blueprint/genesys-cloud-cx-as-code/export/exported_resources/scripts ]; then
            cp -r blueprint/genesys-cloud-cx-as-code/export/exported_resources/scripts \
                  blueprint/genesys-cloud-cx-as-code/
          fi
          
          echo "✓ Exported resources copied to blueprint/genesys-cloud-cx-as-code/"
          echo ""
          echo "Files ready for remote backend deployment:"
          ls -lh blueprint/genesys-cloud-cx-as-code/*.tf blueprint/genesys-cloud-cx-as-code/*.tfvars 2>/dev/null || true
        shell: bash
      
      - name: Deploy to DEV using Terraform Cloud (Remote Backend)
        uses: ./.github/actions/genesys-cloud-apply-terraform
      
      - name: Publish flows with Archy
        run: |
          echo "=== Step 2: Publishing Flows to DEV ==="
          export PATH=$PATH:$GITHUB_WORKSPACE/archy
          
          # Create output directory for results
          mkdir -p $GITHUB_WORKSPACE/output
          
          cd blueprint/genesys-cloud-cx-as-code/export/exported_resources/architect_flows
          
          # Find all YAML flow files
          FLOW_FILES=$(find . -name "*.yaml" -o -name "*.yml")
          
          if [ -z "$FLOW_FILES" ]; then
            echo "✗ No flow files found to publish"
            exit 1
          fi
          
          echo "Found flows to publish:"
          echo "$FLOW_FILES"
          echo ""
          
          # Publish each flow
          for flow_file in $FLOW_FILES; do
            echo "Publishing: $flow_file"
            archy publish \
              --forceUnlock \
              --file "$flow_file" \
              --clientId "$GENESYSCLOUD_OAUTHCLIENT_ID" \
              --clientSecret "$GENESYSCLOUD_OAUTHCLIENT_SECRET" \
              --location "$GENESYSCLOUD_ARCHY_REGION" \
              --overwriteResultsFile \
              --resultsFile "$GITHUB_WORKSPACE/output/results-$(basename $flow_file .yaml).json"
            
            if [ $? -eq 0 ]; then
              echo "✓ Successfully published: $flow_file"
            else
              echo "✗ Failed to publish: $flow_file"
              exit 1
            fi
            echo ""
          done
          
          echo "✓ All flows published successfully"
          cd $GITHUB_WORKSPACE
        shell: bash

  ###s
  #  job: execute-platform-tests
  #
  #  The execute-platform-tests job first sets all of the environment variables needed to run our Python script that was written
  #  to demonstrate how to build a platform test that must past successfully before we deploy to test. Since this is doing nothing
  #  more then running a python script we are just executing python code "in-line" rather then through a local action.
  #
  ###
  # execute-platform-tests:
  #   runs-on: ubuntu-latest
  #   needs: deploy-email-flow-dev
  #   env:
  #     GENESYSCLOUD_OAUTHCLIENT_ID: ${{ secrets.GENESYSCLOUD_OAUTHCLIENT_ID_DEV }}
  #     GENESYSCLOUD_OAUTHCLIENT_SECRET: ${{ secrets.GENESYSCLOUD_OAUTHCLIENT_SECRET_DEV }}
  #     GENESYSCLOUD_REGION: "us-west-2"
  #     GENESYSCLOUD_API_REGION: "https://api.usw2.pure.cloud"
  #   steps:
  #     - uses: actions/checkout@v2
  #     - uses: ./.github/actions/genesys-cloud-dev-tools
  #     - name: Platform tests
  #       run: python blueprint/scripts/platform_tests.py

  ###
  #  job: deploy-email-flow-test
  #
  #  The deploy-email-flow-test job starts by first setting all of the environment variables specific to the test environment. Secret values
  #  are pulled directly from the GitHub Actions secrets vaults. Otherwise, all environment variables are set directly in the script.
  #  Once all of the environment variables are set this job does basically carries out the same steps taken in development environment.
  #
  #  Remember our goal is to have our configuration uniformly applied with all of the environment specific values being applied through
  #  configuration.
  ###
  # deploy-email-flow-test:
  #   runs-on: ubuntu-latest
  #   needs: execute-platform-tests
  #   env:
  #     GENESYSCLOUD_OAUTHCLIENT_ID: ${{ secrets.GENESYSCLOUD_OAUTHCLIENT_ID_TEST }}
  #     GENESYSCLOUD_OAUTHCLIENT_SECRET: ${{ secrets.GENESYSCLOUD_OAUTHCLIENT_SECRET_TEST }}
  #     GENESYSCLOUD_API_REGION: "https://api.usw2.pure.cloud"
  #     GENESYSCLOUD_REGION: "us-west-2"
  #     GENESYSCLOUD_ARCHY_REGION: "usw2.pure.cloud"
  #     GENESYSCLOUD_EMAIL_DOMAIN: "devengagetest"
  #     GENESYSCLOUD_EMAIL_DOMAIN_REGION: "pure.cloud"
  #     TF_WORKSPACE: "test"
  #   steps:
  #     - uses: actions/checkout@v2
  #     - uses: ./.github/actions/genesys-cloud-dev-tools
  #     - uses: hashicorp/setup-terraform@v1
  #       with:
  #         cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
  #     - uses: ./.github/actions/genesys-cloud-apply-terraform
  #     - uses: ./.github/actions/genesys-cloud-publish-archy-flow
  #       with:
  #         architect-flow-path: $GITHUB_WORKSPACE/blueprint/genesys-cloud-architect-flows/EmailComprehendFlow.yaml
  #         architect-results-path: $GITHUB_WORKSPACE/output/results.json
  #     - uses: ./.github/actions/genesys-cloud-create-email-domain-route
