###
# This GitHub action exports HarshTestFlow from DEV environment (usw2)
# and deploys it to TEST environment (use1) via Terraform Cloud remote backend.
#
# Pipeline Flow:
#  1. export-flow-from-dev: Export HarshTestFlow from DEV (us-west-2)
#     - Creates genesyscloud.tf with all flows and dependencies in blueprint/genesys-cloud-cx-as-code/deploy/
#     - Commits all exported resources to GitHub
#  2. deploy-to-test: Deploy to TEST (us-east-1) using Terraform Cloud
#     - Uses deploy/genesyscloud.tf (resources) + deploy/main.tf (backend config)
#     - Deploys via genesys-cloud-apply-terraform action from deploy directory
#
# Environment configurations:
#  DEV:  us-west-2 (usw2.pure.cloud)
#  TEST: us-east-1 (mypurecloud.com) - Workspace: CI_CD_TEST
###
name: Deploy Flow from DEV to TEST
on:
  push:
    branches: [main]
  workflow_dispatch:
jobs:
  ###
  #  job: export-flow-from-dev
  #
  #  This job exports HarshTestFlow from DEV environment (us-west-2).
  #  Exports to blueprint/genesys-cloud-cx-as-code/deploy/genesyscloud.tf (flows and dependencies)
  #  and blueprint/genesys-cloud-cx-as-code/deploy/architect_flows/ (YAML files)
  ###
  export-flow-from-dev:
    runs-on: ubuntu-latest
    env:
      FLOW_NAME: "HarshTestFlow"
      GENESYSCLOUD_OAUTHCLIENT_ID: ${{ secrets.GENESYSCLOUD_OAUTHCLIENT_ID_DEV }}
      GENESYSCLOUD_OAUTHCLIENT_SECRET: ${{ secrets.GENESYSCLOUD_OAUTHCLIENT_SECRET_DEV }}
      GENESYSCLOUD_API_REGION: "https://api.usw2.pure.cloud"
      GENESYSCLOUD_REGION: "us-west-2"
    steps:
      - uses: actions/checkout@v2
      
      - uses: ./.github/actions/genesys-cloud-dev-tools
      
      - uses: hashicorp/setup-terraform@v1
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
      
      - name: List flows in DEV environment
        working-directory: blueprint/genesys-cloud-cx-as-code/export
        run: |
          echo "=== Listing flows in DEV environment (usw2) ==="
          python list-flows.py
        shell: bash
      
      - name: Export HarshTestFlow from DEV
        uses: ./.github/actions/genesys-cloud-export-flows
      
      - name: Clean up exported genesyscloud.tf
        run: |
          echo "=== Cleaning exported genesyscloud.tf ==="
          # Remove terraform block with required_providers to avoid conflict with main.tf
          # The terraform block in main.tf contains the remote backend configuration
          sed -i '/^terraform {/,/^}/d' blueprint/genesys-cloud-cx-as-code/deploy/genesyscloud.tf
          echo "✓ Terraform block removed"
          
          # Remove file_content_hash attribute (computed attribute, cannot be set manually)
          sed -i '/file_content_hash/d' blueprint/genesys-cloud-cx-as-code/deploy/genesyscloud.tf
          echo "✓ file_content_hash attribute removed"
          echo ""
          echo "First 20 lines of cleaned genesyscloud.tf:"
          head -20 blueprint/genesys-cloud-cx-as-code/deploy/genesyscloud.tf
        shell: bash
      
      - name: Verify exported resources
        run: |
          echo "=== Verifying exported resources ==="
          echo "Exported Terraform file (genesyscloud.tf):"
          ls -lh blueprint/genesys-cloud-cx-as-code/deploy/genesyscloud.tf || echo "genesyscloud.tf not found!"
          echo ""
          echo "Exported flow YAML files:"
          ls -lh blueprint/genesys-cloud-cx-as-code/deploy/architect_flows/*.yaml || echo "No YAML files found"
          echo ""
          echo "Contents of deploy directory:"
          ls -la blueprint/genesys-cloud-cx-as-code/deploy/
        shell: bash
      
      - name: Commit all exported resources to GitHub
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git add blueprint/genesys-cloud-cx-as-code/deploy/genesyscloud.tf
          git add blueprint/genesys-cloud-cx-as-code/deploy/architect_flows/
          git add blueprint/genesys-cloud-cx-as-code/deploy/terraform.tfvars || true
          git diff --staged --quiet || git commit -m "Auto-export HarshTestFlow from DEV (usw2) [skip ci]"
          git push origin main --force
        shell: bash

  ###
  #  job: deploy-to-test
  #
  #  This job deploys HarshTestFlow to TEST environment (us-east-1) via Terraform Cloud.
  #  Uses deploy/genesyscloud.tf (exported flows/dependencies) + deploy/main.tf (backend configuration)
  #  Deploys using the genesys-cloud-apply-terraform action from deploy directory
  ###
  deploy-to-test:
    runs-on: ubuntu-latest
    needs: export-flow-from-dev
    env:
      GENESYSCLOUD_OAUTHCLIENT_ID: ${{ secrets.GENESYSCLOUD_OAUTHCLIENT_ID_TEST }}
      GENESYSCLOUD_OAUTHCLIENT_SECRET: ${{ secrets.GENESYSCLOUD_OAUTHCLIENT_SECRET_TEST }}
      GENESYSCLOUD_API_REGION: "https://api.mypurecloud.com"
      GENESYSCLOUD_REGION: "us-east-1"
      TF_WORKSPACE: "CI_CD_TEST"
    steps:
      - uses: actions/checkout@v2
        with:
          ref: main  # Get latest commit with exported resources
      
      - uses: ./.github/actions/genesys-cloud-dev-tools
      
      - uses: hashicorp/setup-terraform@v1
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
      
      - name: Verify exported resources before deployment
        run: |
          echo "=== Verifying resources for deployment ==="
          echo "main.tf (backend config):"
          ls -lh blueprint/genesys-cloud-cx-as-code/deploy/main.tf
          echo ""
          echo "genesyscloud.tf (flows and dependencies):"
          ls -lh blueprint/genesys-cloud-cx-as-code/deploy/genesyscloud.tf
          echo ""
          echo "Flow YAML files:"
          ls -lh blueprint/genesys-cloud-cx-as-code/deploy/architect_flows/*.yaml || echo "No YAML files found"
        shell: bash
      
      - name: Deploy to TEST using Terraform Cloud
        uses: ./.github/actions/genesys-cloud-apply-terraform
      
      - name: Deployment Summary
        if: success()
        run: |
          echo "## Deployment Successful! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Flow:** HarshTestFlow" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** DEV (us-west-2)" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** TEST (us-east-1)" >> $GITHUB_STEP_SUMMARY
          echo "**Terraform Workspace:** CI_CD_TEST" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Deployed:" >> $GITHUB_STEP_SUMMARY
          echo "- deploy/main.tf (Terraform Cloud backend configuration)" >> $GITHUB_STEP_SUMMARY
          echo "- deploy/genesyscloud.tf (Exported flows and dependencies)" >> $GITHUB_STEP_SUMMARY
          echo "- deploy/architect_flows/*.yaml (Flow definitions)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verification Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Check Terraform Cloud workspace: CI_CD_TEST" >> $GITHUB_STEP_SUMMARY
          echo "2. Login to Genesys Cloud TEST org (us-east-1)" >> $GITHUB_STEP_SUMMARY
          echo "3. Navigate to Admin > Architect > Flows" >> $GITHUB_STEP_SUMMARY
          echo "4. Verify HarshTestFlow exists and is configured correctly" >> $GITHUB_STEP_SUMMARY
        shell: bash
